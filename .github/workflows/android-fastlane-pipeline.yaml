name: Build & Deploy Android with Fastlane

on:
  push:
    branches:
      - beta
      - alpha
      - payal-devops
  workflow_dispatch:
    inputs:
      lane:
        description: 'Fastlane lane to run'
        required: true
        default: 'beta'
        type: choice
        options:
          - build_only
          - alpha
          - beta

env:
  JAVA_VERSION: '17'
  RUBY_VERSION: '3.2'

jobs:
  build-and-deploy:
    name: Build & Deploy with Fastlane
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: ðŸ’Ž Set up Ruby ${{ env.RUBY_VERSION }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}

      - name: ðŸ“¦ Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ”§ Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: ðŸ’Ž Install Fastlane
        run: bundle install

      - name: ðŸŽ¯ Set Fastlane Lane
        id: lane
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "lane=${{ github.event.inputs.lane }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/payal-devops" ]; then
            echo "lane=alpha" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/alpha" ]; then
            echo "lane=alpha" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/beta" ]; then
            echo "lane=beta" >> $GITHUB_OUTPUT
          else
            echo "lane=build_only" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Run Fastlane
        run: bundle exec fastlane ${{ steps.lane.outputs.lane }}
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/**/*.apk
          retention-days: 30

      - name: ðŸ“¤ Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/**/*.aab
          retention-days: 30
